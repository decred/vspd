# vspd 1.1.0

This release of vspd introduces several new features and some important
performance improvements. Some of the key highlights are:

- Enable users to set voting preferences for treasury spend voting.
- Dramatically improve performance of the database when it contains a large
  number of tickets.
- Improvements to the web interface such as exposing more stats on the homepage,
  and a tabbed navigation system for the admin screen.

< Upgrade steps>

< Review PRs since July - 36acb8c04a355f292d1c01874ee6b0933fab6429>

## Downgrade Warning

This release contains a backwards incompatible database upgrade.
The new database format is not compatible with previous versions of the vspd
software, and there is no code to downgrade the database back to the previous
version.

Making a copy of the database backup before running the migration is suggested
in order to enable rolling back to a previous version of the software.

## Dependencies

vspd 1.1.0 requires:

- dcrd 1.7.0
- dcrwallet 1.7.0

When deploying vspd to production, always use release versions of all binaries.
Neither vspd nor its dependencies should be built from master when handling
mainnet tickets.

## Notable Changes

### Treasury Spend Voting

This release adds the ability for VSP users to set their voting preferences for
transactions spending from the Decred treasury.

Users can either set their voting prefence for a single TSpend hash (a.k.a.
TSpend policy), or they can chose to set a preference for all TSpends signed by
a specific Treasury key (a.k.a. Treasury policy).
This corresponds directly to the API which is exposed by dcrwallet.

TSpend and Treasury policies will be returned from the `/ticketinfo` endpoint,
as well as being shown in ticket lookup section of the admin screen.
Any requests which set or update TSpend or Treasury policies will be recorded in
the same manner that requests updating consensus vote choices are currently
recorded.

### Admin screen improvements

- Tabbed navigation
  - Voting wallet
  - Ticket Search
  - Database
  - Logout
- Wallet status table redesigned to match Decred look and feel.
- Database size is now shown
- Ticket information
  - JSON is now indented
  - Ticket fees displayed in DCR rather than atoms
  - Add links to block explorer for hashes/blocks/addresses
  - Table split into Ticket, Fee and Vote Choice sections.
- Display purchase height for tickets
- Show properly formatted timestamp instead of unix time

### General UI improvements

- Comma separate large values.
- Network proportion added to displayed stats.
- Display number of a revoked tickets as proportion of all tickets.
- Include timezone in timestamps.
- Add cache-busting to all web resources to ensure web clients will always
  download new versions when resources change.

### API changes

< Double check these - do a diff on types.go >

- T Spend options added
- Network proportion, closed message and best block height added to /vspinfo

### Config Changes

- Behaviour of the internal log rotator can now be customised using new
  `maxlogsize` and `logstokeep` options.
- A new option `vspclosedmsg` can be used to display a short message on the
  webpage when `vspclosed` is set to true. The message will also be returned by
  the `/vspinfo` API endpoint.

### Database Performance

In order to preemptively deal with scaling issues seen on vspd databases
containing very large numbers of tickets, a number of changes have been made to
the database code and the database storage format.

- Each ticket is now stored in its own database bucket. Previously tickets were
  stored in a single bucket as JSON encoded strings.
- Previously when searching through all tickets in the database with a filter,
  every ticket would be fully deserialized. Now only tickets which match the
  filter are deserialized.
- The fee payment raw transaction hex is now only stored in the database for as
  long as it is required. Once the transaction is confirmed on-chain, the hex is
  deleted from the database.

< Mention bbolt compact >
< Include some 1.0 vs 1.1 comparisons >

### Bug Fixes

- Ensure purchase height is always set for every ticket.
- Wait for any running notification handlers to finish before closing RPC/DB
  connections.
- Removed two data races in the API data caching code.
- Ensure panics generated by web requests are logged to file and not only
  stdout. This includes logging a stack trace, and the full body and headers of
  the HTTP request which caused the panic.
- Return an error response to clients if generating a fee address fails.
